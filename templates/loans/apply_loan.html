{% extends 'base.html' %}

{% block title %}Apply for Loan - Hela Fund{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>Loan Eligibility Application
                    </h3>
                </div>
                <div class="card-body">
                    <form method="post" id="loanApplicationForm" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.phone_number.id_for_label }}" class="form-label">Phone Number <span class="text-danger">*</span></label>
                                {{ form.phone_number }}
                                {% if form.phone_number.errors %}
                                {% if form.phone_number.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.phone_number.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                                {% if form.phone_number.help_text %}
                                <div class="form-text">{{ form.phone_number.help_text }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.id_number.id_for_label }}" class="form-label">ID Number <span class="text-danger">*</span></label>
                                {{ form.id_number }}
                                {% if form.id_number.errors %}
                                {% if form.id_number.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.id_number.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                                {% if form.id_number.help_text %}
                                <div class="form-text">{{ form.id_number.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.gender.id_for_label }}" class="form-label">Gender <span class="text-danger">*</span></label>
                                {{ form.gender }}
                                {% if form.gender.errors %}
                                {% if form.gender.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.gender.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">Date of Birth <span class="text-danger">*</span></label>
                                {{ form.date_of_birth }}
                                {% if form.date_of_birth.errors %}
                                {% if form.date_of_birth.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.date_of_birth.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.marital_status.id_for_label }}" class="form-label">Marital Status <span class="text-danger">*</span></label>
                                {{ form.marital_status }}
                                {% if form.marital_status.errors %}
                                {% if form.marital_status.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.marital_status.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.county.id_for_label }}" class="form-label">County <span class="text-danger">*</span></label>
                                {{ form.county }}
                                {% if form.county.errors %}
                                {% if form.county.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.county.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.next_of_kin.id_for_label }}" class="form-label">Next of Kin <span class="text-danger">*</span></label>
                                {{ form.next_of_kin }}
                                {% if form.next_of_kin.errors %}
                                {% if form.next_of_kin.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.next_of_kin.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                                {% if form.next_of_kin.help_text %}
                                <div class="form-text">{{ form.next_of_kin.help_text }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.next_of_kin_phone.id_for_label }}" class="form-label">Next of Kin Phone <span class="text-danger">*</span></label>
                                {{ form.next_of_kin_phone }}
                                {% if form.next_of_kin_phone.errors %}
                                {% if form.next_of_kin_phone.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.next_of_kin_phone.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                                {% if form.next_of_kin_phone.help_text %}
                                <div class="form-text">{{ form.next_of_kin_phone.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.education_level.id_for_label }}" class="form-label">Level of Education <span class="text-danger">*</span></label>
                                {{ form.education_level }}
                                {% if form.education_level.errors %}
                                {% if form.education_level.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.education_level.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                                {% if form.education_level.help_text %}
                                <div class="form-text">{{ form.education_level.help_text }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <!-- Empty column for layout balance -->
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.employment_status.id_for_label }}" class="form-label">Employment Status <span class="text-danger">*</span></label>
                                {{ form.employment_status }}
                                {% if form.employment_status.errors %}
                                {% if form.employment_status.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.employment_status.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.monthly_income.id_for_label }}" class="form-label">Monthly Income (KES) <span class="text-danger">*</span></label>
                                {{ form.monthly_income }}
                                {% if form.monthly_income.errors %}
                                {% if form.monthly_income.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.monthly_income.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="{{ form.loan_purpose.id_for_label }}" class="form-label">Loan Purpose <span class="text-danger">*</span></label>
                                {{ form.loan_purpose }}
                                {% if form.loan_purpose.errors %}
                                {% if form.loan_purpose.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.loan_purpose.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.requested_amount.id_for_label }}" class="form-label">Loan Amount (KES) <span class="text-danger">*</span></label>
                                {{ form.requested_amount }}
                                {% if form.requested_amount.errors %}
                                {% if form.requested_amount.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.requested_amount.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.repayment_period.id_for_label }}" class="form-label">Repayment Period (Months) <span class="text-danger">*</span></label>
                                {{ form.repayment_period }}
                                {% if form.repayment_period.errors %}
                                {% if form.repayment_period.errors.0 != 'This field is required.' %}
                                <div class="text-danger small">{{ form.repayment_period.errors.0 }}</div>
                                {% endif %}
                                {% endif %}
                                {% if form.repayment_period.help_text %}
                                <div class="form-text">{{ form.repayment_period.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'loans:dashboard' %}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-paper-plane me-2"></i>Submit Application
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('loanApplicationForm');
    const submitBtn = document.getElementById('submitBtn');
    
    // Add required attribute to all form fields
    const requiredFields = form.querySelectorAll('input, select, textarea');
    requiredFields.forEach(field => {
        if (field.type !== 'hidden' && field.name !== 'csrfmiddlewaretoken') {
            field.setAttribute('required', 'required');
        }
    });
    
    // Real-time validation
    requiredFields.forEach(field => {
        field.addEventListener('blur', function() {
            validateField(this);
        });
        
        field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                validateField(this);
            }
        });
    });
    
    function validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        
        // Remove existing validation classes
        field.classList.remove('is-valid', 'is-invalid');
        
        // Check if field is empty
        if (!value) {
            field.classList.add('is-invalid');
            return false;
        }
        
        // Specific validation for phone numbers
        if (fieldName === 'phone_number' || fieldName === 'next_of_kin_phone') {
            if (!/^\d{10}$/.test(value)) {
                field.classList.add('is-invalid');
                return false;
            }
        }
        
        // Specific validation for ID number
        if (fieldName === 'id_number') {
            if (!/^\d{8}$/.test(value)) {
                field.classList.add('is-invalid');
                return false;
            }
        }
        
        // Specific validation for loan amount
        if (fieldName === 'requested_amount') {
            const amount = parseFloat(value);
            if (isNaN(amount) || amount < 1000) {
                field.classList.add('is-invalid');
                return false;
            }
        }
        
        // Specific validation for repayment period
        if (fieldName === 'repayment_period') {
            const period = parseInt(value);
            if (isNaN(period) || period < 1 || period > 60) {
                field.classList.add('is-invalid');
                return false;
            }
        }
        
        // If all validations pass
        field.classList.add('is-valid');
        return true;
    }
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        let isValid = true;
        const requiredFields = form.querySelectorAll('input[required], select[required], textarea[required]');
        
        requiredFields.forEach(field => {
            if (!validateField(field)) {
                isValid = false;
            }
        });
        
        if (isValid) {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
            
            // Submit the form
            form.submit();
        } else {
            // Scroll to first invalid field
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalid.focus();
            }
            
            // Show error message
            showAlert('Please fill in all required fields correctly.', 'danger');
        }
    });
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const cardBody = document.querySelector('.card-body');
        cardBody.insertBefore(alertDiv, cardBody.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.form-control.is-valid {
    border-color: #198754;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.94-.94 3.03-3.03-1.06-1.06-1.97 1.97-.94.94-1.06-1.06z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 1.4 1.4m0-1.4-1.4 1.4'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.form-control.is-valid:focus {
    border-color: #198754;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
}

.btn:disabled {
    opacity: 0.65;
    cursor: not-allowed;
}

/* Make select placeholder lighter */
select.form-select option[value=""],
select.form-control option[value=""] {
    color: #b0b0b0;
    font-weight: 400;
}
</style>
{% endblock %} 